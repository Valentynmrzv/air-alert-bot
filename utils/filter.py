import re

# –ù–∞—à—ñ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ —Ä–µ–≥—ñ–æ–Ω–∏ (–Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–±–∏—Ç—å—Å—è —Ç—É—Ç –∂–µ)
ALLOWED_DISTRICTS = {"–±—Ä–æ–≤–∞—Ä—Å—å–∫–∏–π —Ä–∞–π–æ–Ω", "–∫–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"}

# –ü–æ—à—É–∫–æ–≤—ñ –∫–ª—é—á—ñ –¥–ª—è –≥–µ–æ —ñ —à–≤–∏–¥–∫–∏—Ö –∑–∞–≥—Ä–æ–∑
REGION_KEYWORDS = [
    "–±—Ä–æ–≤–∞—Ä", "–±—Ä–æ–≤–∞—Ä–∏", "–±—Ä–æ–≤–∞—Ä—Å—å–∫–∏–π",
    "–∫–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å", "–∫–∏—ó–≤—â–∏–Ω–∞", "–∫–∏—ó–≤",
    "–∫–Ω—è–∂–∏—á", "—Ç—Ä–µ–±—É—Ö", "–∫–∞–ª–∏–Ω—ñ–≤–∫", "–≤–µ–ª–∏–∫–∞ –¥–∏–º–µ—Ä", "–º–∞–ª–∞ –¥–∏–º–µ—Ä",
    "–±–æ–≥–¥–∞–Ω—ñ–≤–∫", "–∫—Ä–∞—Å–∏–ª—ñ–≤–∫", "–ø–æ–≥—Ä–µ–±–∏", "–∑–∞–∑–∏–º", "–ª—ñ—Ç–∫–∏", "–ø—É—Ö—ñ–≤–∫",
    "—Ä–æ–∂–Ω–∏", "—Å–≤—ñ—Ç–∏–ª—å–Ω", "—Å–µ–º–∏–ø–æ–ª–∫", "–∫–≤—ñ—Ç–Ω–µ–≤", "–ø–µ—Ä–µ–º–æ–≥", "–≥–æ–≥–æ–ª", "–∫–∞–ª–∏—Ç–∞",
    "–±–æ—Ä–∏—Å–ø—ñ–ª", "—Ç—Ä–æ—î—â–∏–Ω", "–ª—ñ—Å–æ–≤", "–¥–∞—Ä–Ω–∏—Ü", "–≤–∏—à–≥–æ—Ä–æ–¥", "–æ–±—É—Ö", "—ñ—Ä–ø—ñ–Ω", "–±—É—á–∞",
    "–≥–æ—Å—Ç–æ–º–µ–ª", "–≤–∏—à–Ω–µ–≤", "–≤–∞—Å–∏–ª—å–∫", "–±–µ—Ä–µ–∑–∞–Ω", "–±–∞—Ä–∏—à—ñ–≤–∫",
]

RAPID_THREATS = [
    # —à–≤–∏–¥–∫—ñ –∑–∞–≥—Ä–æ–∑–∏ / –±–∞–ª—ñ—Å—Ç–∏–∫–∞ / –Ω–æ—Å—ñ—ó
    "–±–∞–ª—ñ—Å—Ç–∏–∫", "–±–∞–ª–ª–∏—Å—Ç–∏–∫",
    "—ñ—Å–∫–∞–Ω–¥–µ—Ä", "–∏—Å–∫–∞–Ω–¥–µ—Ä",
    "–∫–∏–Ω–∂–∞–ª", "–∫–∏–Ω–∂–∞–ª–∞", "–º–∏–≥-31", "–º—ñ–≥-31", "–º–∏–≥ 31", "–º—ñ–≥ 31",
    "mig-31", "mig 31",
    "–∑–ª—ñ—Ç", "–≤–∑–ª–µ—Ç",
    # —á–∞—Å—Ç–æ –≤ –Ω–æ–≤–∏–Ω–∞—Ö:
    "–ø—É—Å–∫–∏", "–ø—É—Å–∫", "–∑–∞–ø—É—Å–∫", "–∑–∞–ø—É—Å–∫–∏",
]

THREAT_WORDS = [
    # –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏/—Ç–µ–≥–∞ "threat_type" (–Ω–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –ø–æ–≤–Ω–∏–π)
    "—à–∞—Ö–µ–¥", "shahed", "–¥—Ä–æ–Ω", "–±–ø–ª–∞", "—Ä–∞–∫–µ—Ç–∞", "–±–∞–ª—ñ—Å—Ç–∏–∫", "—ñ—Å–∫–∞–Ω–¥–µ—Ä", "–∫–∏–Ω–∂–∞–ª",
]

# –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç @air_alert_ua:
# "üî¥ 21:05 –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ –≤ –ë—Ä–æ–≤–∞—Ä—Å—å–∫–∏–π —Ä–∞–π–æ–Ω." / "üü¢ 00:12 –í—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏ –≤ –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å."
# –ú–æ–∂–µ –±—É—Ç–∏ –∫—Ä–∞–ø–∫–∞/–∑–Ω–∞–∫/–ø–µ—Ä–µ–Ω–æ—Å –¥–∞–ª—ñ, —Ç–æ–º—É –≤–∏—Ä—ñ–∑–∞—î–º–æ –¥–æ –ø–µ—Ä—à–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫–∞.
OFFICIAL_RE = re.compile(
    r"(–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞\s+—Ç—Ä–∏–≤–æ–≥–∞|–≤—ñ–¥–±—ñ–π\s+—Ç—Ä–∏–≤–æ–≥–∏)\s+–≤\s+([^\n\.#!]+)",
    re.IGNORECASE | re.UNICODE,
)

def _norm_district(d: str) -> str:
    d = (d or "").strip().lower()
    # –ø—Ä–∏–±—Ä–∞—Ç–∏ —Å–ª—É–∂–±–æ–≤—ñ –∫—Ä–∞–ø–∫–∏ —Ç–∞ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ —Ç–∏–ø—É "–º. –∫–∏—ó–≤"
    d = d.replace("–º. ", "").strip()
    return d

def _is_region_hit(lower: str) -> bool:
    return any(k in lower for k in REGION_KEYWORDS)

def _is_rapid_hit(lower: str) -> bool:
    return any(k in lower for k in RAPID_THREATS)

def _guess_threat(lower: str):
    for w in THREAT_WORDS:
        if w in lower:
            return w
    return None

def classify_message(text: str, url: str, source: str | None = None):
    """
    –ü–æ–≤–µ—Ä—Ç–∞—î:
      - –¥–ª—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ @air_alert_ua: dict –∑ type in {'alarm','all_clear'} –∞–±–æ None —è–∫—â–æ –Ω–µ –Ω–∞—à —Ä–µ–≥—ñ–æ–Ω;
      - –¥–ª—è —ñ–Ω—à–∏—Ö: dict –∑ type='info' + region_hit/rapid_hit + threat_type (—è–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ).
    """
    if not text:
        return None

    lower = text.lower()

    # 1) –û–§–Ü–¶–Ü–ô–ù–ò–ô –∫–∞–Ω–∞–ª: —à—É–∫–∞—î–º–æ "–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞/–≤—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏ –≤ <—Ä–µ–≥—ñ–æ–Ω>"
    if source == "air_alert_ua":
        m = OFFICIAL_RE.search(lower)
        if not m:
            return None

        phrase = m.group(1)  # "–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞" –∞–±–æ "–≤—ñ–¥–±—ñ–π —Ç—Ä–∏–≤–æ–≥–∏"
        district_raw = m.group(2)
        district_norm = _norm_district(district_raw)

        # –ü—Ä–∞—Ü—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑ –Ω–∞—à–∏–º–∏ —Ä–µ–≥—ñ–æ–Ω–∞–º–∏
        if district_norm not in ALLOWED_DISTRICTS:
            return None

        typ = "alarm" if "–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞" in phrase else "all_clear"

        return {
            "district": district_norm,
            "text": text,
            "url": url,
            "id": hash(text + url),
            "type": typ,
            # –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –ø–æ—Å—Ç–∏ –Ω–µ —Ç–µ–≥—É—î–º–æ region/rapid ‚Äî —Ü–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        }

    # 2) –ù–ï–æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –∫–∞–Ω–∞–ª–∏ ‚Üí INFO
    region_hit = _is_region_hit(lower)
    rapid_hit = _is_rapid_hit(lower)
    threat = _guess_threat(lower)

    return {
        "district": None,              # —Ä–∞–π–æ–Ω –Ω–µ –∑ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ ‚Äî –Ω–µ –¥–æ–≤—ñ—Ä—è—î–º–æ
        "text": text,
        "url": url,
        "id": hash(text + url),
        "type": "info",
        "region_hit": region_hit,
        "rapid_hit": rapid_hit,
        "threat_type": threat,
        "source": source,
    }
